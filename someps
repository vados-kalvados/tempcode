param (
    [string]$Folder,
    [int]$Days
)

# Function to get the last working day of a given month
function Get-LastWorkingDay {
    param (
        [datetime]$date
    )

    # Get the last day of the month
    $lastDay = [datetime]::DaysInMonth($date.Year, $date.Month)
    $lastWorkingDay = Get-Date -Year $date.Year -Month $date.Month -Day $lastDay

    # Adjust if the last day is a weekend (Saturday/Sunday)
    while ($lastWorkingDay.DayOfWeek -eq 'Saturday' -or $lastWorkingDay.DayOfWeek -eq 'Sunday') {
        $lastWorkingDay = $lastWorkingDay.AddDays(-1)
    }

    return $lastWorkingDay
}

# Function to check if the filename or foldername contains a date pattern matching the last working day
function ContainsLastWorkingDay {
    param (
        [string]$name
    )

    $datePattern = "\d{4}-\d{2}-\d{2}"
    if ($name -match $datePattern) {
        $dateStr = $matches[0]
        try {
            $date = [datetime]::ParseExact($dateStr, 'yyyy-MM-dd', $null)
        } catch {
            return $false
        }

        $lastWorkingDay = Get-LastWorkingDay $date

        return $date -eq $lastWorkingDay
    }

    return $false
}

# Get the current date
$now = Get-Date

# Calculate the cutoff date
$cutoffDate = $now.AddDays(-$Days)

# Get all files and folders recursively
$items = Get-ChildItem -Path $Folder -Recurse -Force

foreach ($item in $items) {
    if ($item -is [System.IO.FileInfo] -or $item -is [System.IO.DirectoryInfo]) {
        if ($item.PSIsContainer) {
            # Check if the folder name contains a date pattern matching the last working day
            if (-not (ContainsLastWorkingDay $item.Name)) {
                # Get the last write time of the folder
                if ($item.LastWriteTime -lt $cutoffDate) {
                    try {
                        Remove-Item -Path $item.FullName -Recurse -Force -ErrorAction Stop
                        Write-Output "Deleted folder: $($item.FullName)"
                    } catch {
                        Write-Warning "Failed to delete folder: $($item.FullName). Error: $_"
                    }
                }
            }
        } else {
            # Check if the file name contains a date pattern matching the last working day
            if (-not (ContainsLastWorkingDay $item.Name)) {
                # Get the last write time of the file
                if ($item.LastWriteTime -lt $cutoffDate) {
                    try {
                        Remove-Item -Path $item.FullName -Force -ErrorAction Stop
                        Write-Output "Deleted file: $($item.FullName)"
                    } catch {
                        Write-Warning "Failed to delete file: $($item.FullName). Error: $_"
                    }
                }
            }
        }
    }
}
